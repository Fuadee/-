export type SpecInput = {
  name: string;
  purpose?: string;
  qty?: number;
  unit?: string;
  style?: "short" | "medium";
};

type TemplateBuilder = (input: SpecInput, detail: string, qtyText: string, purposeText: string) => string[];

const DETAIL_PATTERNS: RegExp[] = [
  /\bA\s*\d\b/i,
  /\d+(?:\.\d+)?\s*(?:oz|ออนซ์)/i,
  /\d+(?:\.\d+)?\s*แกรม/i,
  /\d+(?:\.\d+)?\s*(?:นิ้ว|\")/i,
  /\d+(?:\.\d+)?\s*(?:ml|l|ลิตร)/i,
  /\d+(?:\.\d+)?\s*(?:v|โวลต์|ah|mah)/i,
  /\d+\s*[x×]\s*\d+(?:\s*[x×]\s*\d+)?/i
];

const getDetailFromName = (name: string): string => {
  const matches = DETAIL_PATTERNS.map((pattern) => name.match(pattern)?.[0]).filter(Boolean) as string[];
  if (matches.length === 0) {
    return "ขนาดมาตรฐานตามการใช้งานทั่วไป";
  }
  return `ระบุ ${Array.from(new Set(matches)).join(", ")}`;
};

const getQtyText = (qty?: number, unit?: string): string => {
  if (!qty || qty <= 0) {
    return "จำนวนตามความจำเป็นของหน่วยงาน";
  }
  const normalizedUnit = unit?.trim() || "หน่วย";
  return `จำนวน ${qty} ${normalizedUnit}`;
};

const getPurposeText = (purpose?: string): string => {
  if (!purpose?.trim()) {
    return "รองรับงานสำนักงานและภารกิจภายในหน่วยงาน";
  }
  return purpose.trim();
};

const buildGenericTemplate: TemplateBuilder = (input, detail, qtyText, purposeText) => [
  `ลักษณะ/วัสดุ: ${input.name} ผลิตจากวัสดุที่เหมาะสมกับการใช้งานทั่วไป มีความเรียบร้อยและปลอดภัยต่อผู้ใช้งาน`,
  `ขนาด/รายละเอียด: ${detail} (${qtyText})`,
  "คุณภาพ/ความแข็งแรง: มีความคงทน แข็งแรงตามมาตรฐานที่ยอมรับได้ในงานจัดซื้อจัดจ้าง",
  `เหมาะสำหรับ: ${purposeText}`,
  "ของใหม่/ไม่ชำรุด/พร้อมใช้งาน: ต้องเป็นของใหม่ ไม่ผ่านการใช้งาน ไม่มีตำหนิ และพร้อมใช้งานทันที"
];

const TEMPLATE_MAP: Array<{ keyword: string; build: TemplateBuilder }> = [
  { keyword: "แก้วกระดาษ", build: (i, d, q, p) => [
    "ลักษณะ/วัสดุ: แก้วกระดาษสำหรับบรรจุเครื่องดื่ม ผลิตจากกระดาษคุณภาพดี เคลือบกันซึม",
    `ขนาด/รายละเอียด: ${d} ปากแก้วเรียบ จับถนัดมือ (${q})`,
    "คุณภาพ/ความแข็งแรง: ทนต่อความร้อนหรือความเย็นตามลักษณะการใช้งานทั่วไป ไม่รั่วซึมง่าย",
    `เหมาะสำหรับ: ${p}`,
    "ของใหม่/ไม่ชำรุด/พร้อมใช้งาน: สะอาด บรรจุภัณฑ์เรียบร้อย และพร้อมใช้งาน"
  ]},
  { keyword: "ถุงขยะ", build: (i, d, q, p) => [
    "ลักษณะ/วัสดุ: ถุงขยะพลาสติกเนื้อเหนียว ยืดหยุ่นดี รองรับการใช้งานประจำวัน",
    `ขนาด/รายละเอียด: ${d} รองรับปริมาตรขยะได้เหมาะสม (${q})`,
    "คุณภาพ/ความแข็งแรง: ไม่ฉีกขาดง่าย ทนรับน้ำหนักได้ในระดับงานทั่วไป",
    `เหมาะสำหรับ: ${p}`,
    "ของใหม่/ไม่ชำรุด/พร้อมใช้งาน: ถุงใหม่ สะอาด ไม่มีรอยขาด พร้อมใช้งาน"
  ]},
  { keyword: "กระดาษ a4", build: (i, d, q, p) => [
    "ลักษณะ/วัสดุ: กระดาษถ่ายเอกสารสีขาว เรียบเนียน เหมาะสำหรับงานพิมพ์เอกสารราชการ",
    `ขนาด/รายละเอียด: ขนาด A4 และ/หรือ ${d} (${q})`,
    "คุณภาพ/ความแข็งแรง: เนื้อกระดาษสม่ำเสมอ ไม่ติดเครื่องพิมพ์ง่าย และให้ตัวอักษรคมชัด",
    `เหมาะสำหรับ: ${p}`,
    "ของใหม่/ไม่ชำรุด/พร้อมใช้งาน: อยู่ในหีบห่อเรียบร้อย ไม่ชื้น ไม่ยับ และพร้อมใช้งาน"
  ]},
  { keyword: "ปากกา", build: (i, d, q, p) => [
    "ลักษณะ/วัสดุ: ปากกาสำหรับงานเขียนทั่วไป จับถนัดมือ หมึกไหลสม่ำเสมอ",
    `ขนาด/รายละเอียด: ${d} สีหมึกชัดเจน (${q})`,
    "คุณภาพ/ความแข็งแรง: โครงสร้างแข็งแรง ใช้งานต่อเนื่องได้ดี ไม่รั่วซึมง่าย",
    `เหมาะสำหรับ: ${p}`,
    "ของใหม่/ไม่ชำรุด/พร้อมใช้งาน: สินค้าใหม่ บรรจุเรียบร้อย พร้อมใช้งานทันที"
  ]},
  { keyword: "แฟ้ม", build: (i, d, q, p) => [
    "ลักษณะ/วัสดุ: แฟ้มเอกสารสำหรับจัดเก็บงาน ผลิตจากวัสดุแข็งแรง เปิด-ปิดสะดวก",
    `ขนาด/รายละเอียด: ${d} รองรับเอกสารได้เหมาะสม (${q})`,
    "คุณภาพ/ความแข็งแรง: ไม่ฉีกขาดหรือเสียรูปง่าย เหมาะกับการใช้งานต่อเนื่อง",
    `เหมาะสำหรับ: ${p}`,
    "ของใหม่/ไม่ชำรุด/พร้อมใช้งาน: สินค้าใหม่ ไม่มีตำหนิ และพร้อมใช้งาน"
  ]},
  { keyword: "คลิปหนีบ", build: (i, d, q, p) => [
    "ลักษณะ/วัสดุ: คลิปหนีบเอกสารโลหะหรือวัสดุเทียบเท่า หนีบแน่น ใช้งานสะดวก",
    `ขนาด/รายละเอียด: ${d} รองรับจำนวนเอกสารตามขนาด (${q})`,
    "คุณภาพ/ความแข็งแรง: สปริงยึดแน่น ไม่หลุดง่าย ทนต่อการใช้งานประจำ",
    `เหมาะสำหรับ: ${p}`,
    "ของใหม่/ไม่ชำรุด/พร้อมใช้งาน: ใหม่ ไม่เป็นสนิม และพร้อมใช้งาน"
  ]},
  { keyword: "ซองเอกสาร", build: (i, d, q, p) => [
    "ลักษณะ/วัสดุ: ซองเอกสารกระดาษหรือวัสดุเทียบเท่า สำหรับบรรจุเอกสารอย่างเป็นระเบียบ",
    `ขนาด/รายละเอียด: ${d} ปิดผนึกได้เรียบร้อย (${q})`,
    "คุณภาพ/ความแข็งแรง: เนื้อซองไม่ขาดง่าย ป้องกันเอกสารเสียหายระหว่างจัดส่ง",
    `เหมาะสำหรับ: ${p}`,
    "ของใหม่/ไม่ชำรุด/พร้อมใช้งาน: สินค้าใหม่ สภาพสมบูรณ์ และพร้อมใช้งาน"
  ]},
  { keyword: "แบตเตอรี่", build: (i, d, q, p) => [
    "ลักษณะ/วัสดุ: แบตเตอรี่สำหรับอุปกรณ์ไฟฟ้าทั่วไป ให้พลังงานสม่ำเสมอ",
    `ขนาด/รายละเอียด: ${d} ขั้วและขนาดตรงตามการใช้งาน (${q})`,
    "คุณภาพ/ความแข็งแรง: เก็บประจุได้ดี ใช้งานได้ต่อเนื่องตามมาตรฐานสินค้า",
    `เหมาะสำหรับ: ${p}`,
    "ของใหม่/ไม่ชำรุด/พร้อมใช้งาน: ใหม่ ไม่รั่วซึม ไม่เสียรูป และพร้อมใช้งาน"
  ]},
  { keyword: "น้ำดื่ม", build: (i, d, q, p) => [
    "ลักษณะ/วัสดุ: น้ำดื่มบรรจุภาชนะปิดสนิท สะอาด เหมาะกับการบริโภค",
    `ขนาด/รายละเอียด: ${d} บรรจุภัณฑ์สะดวกต่อการแจกจ่าย (${q})`,
    "คุณภาพ/ความแข็งแรง: ภาชนะไม่รั่วซึม มีความสะอาดและสภาพเรียบร้อย",
    `เหมาะสำหรับ: ${p}`,
    "ของใหม่/ไม่ชำรุด/พร้อมใช้งาน: สินค้าใหม่ ปิดผนึกสมบูรณ์ พร้อมใช้งาน"
  ]},
  { keyword: "ผ้าเช็ดทำความสะอาด", build: (i, d, q, p) => [
    "ลักษณะ/วัสดุ: ผ้าสำหรับเช็ดทำความสะอาด เนื้อผ้านุ่ม ซึมซับได้ดี",
    `ขนาด/รายละเอียด: ${d} ใช้งานได้ทั้งพื้นผิวทั่วไปและอุปกรณ์สำนักงาน (${q})`,
    "คุณภาพ/ความแข็งแรง: ทนทานต่อการใช้งาน ไม่ขาดรุ่ยง่าย",
    `เหมาะสำหรับ: ${p}`,
    "ของใหม่/ไม่ชำรุด/พร้อมใช้งาน: สินค้าใหม่ สะอาด พร้อมใช้งาน"
  ]}
];

const pickTemplate = (name: string): TemplateBuilder | null => {
  const lowered = name.toLowerCase();
  const found = TEMPLATE_MAP.find(({ keyword }) => lowered.includes(keyword));
  return found?.build ?? null;
};

export function generateSpec(input: SpecInput): string {
  const name = input.name.trim();
  if (!name) {
    return "";
  }

  const style = input.style ?? "medium";
  const detail = getDetailFromName(name);
  const qtyText = getQtyText(input.qty, input.unit);
  const purposeText = getPurposeText(input.purpose);

  const template = pickTemplate(name) ?? buildGenericTemplate;
  const lines = template({ ...input, name }, detail, qtyText, purposeText);

  if (style === "short") {
    return [lines[0], lines[1], lines[3]].filter(Boolean).slice(0, 3).join("\n");
  }

  return lines.slice(0, 5).join("\n");
}
